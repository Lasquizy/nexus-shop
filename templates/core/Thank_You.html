{% extends "base.html" %}

{% block title %}Merci pour votre commande #{{ order.reference }} - NexusShop{% endblock %}

{% block content %}
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    .fade-in-delay-1 { animation: fadeInUp 0.6s ease-out 0.2s forwards; opacity: 0; }
    .fade-in-delay-2 { animation: fadeInUp 0.6s ease-out 0.4s forwards; opacity: 0; }
    .fade-in-delay-3 { animation: fadeInUp 0.6s ease-out 0.6s forwards; opacity: 0; }

    /* Custom scrollbar pour le récapitulatif produit */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
</style>

    <div id="confetti-container"></div>
    
    <div class="min-h-screen flex flex-col bg-gray-50"> <main class="flex-grow">
            <div class="container mx-auto px-4 py-8 md:py-12">
                <div class="max-w-6xl mx-auto">
                    
                    <div class="text-center mb-12 fade-in">
                        <div class="relative inline-flex items-center justify-center mb-6">
                            <div class="absolute inset-0 w-32 h-32 rounded-full bg-green-100 animate-pulse"></div>
                            <svg class="relative w-24 h-24 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke-width="2" class="opacity-25" fill="none"/>
                                <path d="M9 12l2 2 4-4" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            </svg>
                        </div>
                        
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">Merci pour votre commande {{ order.full_name }} !</h1>
                        <p class="text-lg text-gray-600 mb-2">Votre commande a été confirmée avec succès.</p>
                        
                        <div class="inline-flex items-center justify-center px-6 py-3 bg-blue-50 rounded-full mb-4">
                            <span class="text-gray-700 mr-2">Numéro de commande :</span>
                            <span class="font-bold text-blue-600 text-lg">#{{ order.reference }}</span>
                        </div>
                        <p class="text-gray-600">
                            Un email de confirmation a été envoyé à <span class="font-medium">{{ order.email }}</span>
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                        <div class="space-y-8 fade-in-delay-1">
                            
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8">
                                <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                                    <i class="fas fa-truck text-blue-500 mr-3" aria-hidden="true"></i>
                                    Suivi de votre commande
                                </h2>
                                
                                <div class="space-y-8 relative">
                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center">
                                            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center text-white shrink-0 z-10">
                                                <i class="fas fa-check text-xs"></i>
                                            </div>
                                            <div class="w-0.5 h-full {% if order.status != 'PENDING' %}bg-green-500{% else %}bg-gray-200{% endif %}"></div>
                                        </div>
                                        <div class="pb-8">
                                            <h3 class="font-bold text-gray-900">Commande reçue</h3>
                                            <p class="text-gray-600 text-sm">Validée le {{ order.created_at|date:"d/m/Y" }}</p>
                                        </div>
                                    </div>

                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center">
                                            <div class="w-8 h-8 rounded-full border-2 {% if order.status == 'PAID' or order.status == 'SHIPPED' or order.status == 'DELIVERED' %}border-green-500{% else %}border-gray-200{% endif %} bg-white flex items-center justify-center shrink-0 z-10">
                                                {% if order.status == 'PAID' %}
                                                    <div class="w-2.5 h-2.5 rounded-full bg-green-500 animate-ping"></div>
                                                {% elif order.status == 'SHIPPED' or order.status == 'DELIVERED' %}
                                                    <i class="fas fa-check text-xs text-green-500"></i>
                                                {% else %}
                                                    <div class="w-2.5 h-2.5 rounded-full bg-gray-200"></div>
                                                {% endif %}
                                            </div>
                                            <div class="w-0.5 h-full {% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}bg-green-500{% else %}bg-gray-200{% endif %}"></div>
                                        </div>
                                        <div class="pb-8">
                                            <h3 class="font-bold {% if order.status == 'PAID' or order.status == 'SHIPPED' or order.status == 'DELIVERED' %}text-gray-900{% else %}text-gray-400{% endif %}">En préparation</h3>
                                            <p class="{% if order.status == 'PAID' or order.status == 'SHIPPED' or order.status == 'DELIVERED' %}text-gray-600{% else %}text-gray-400{% endif %} text-sm">Nous préparons vos articles.</p>
                                        </div>
                                    </div>

                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center">
                                            <div class="w-8 h-8 rounded-full {% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-400{% endif %} flex items-center justify-center shrink-0 z-10">
                                                {% if order.status == 'SHIPPED' %}
                                                    <i class="fas fa-shipping-fast text-xs animate-bounce"></i>
                                                {% elif order.status == 'DELIVERED' %}
                                                    <i class="fas fa-check text-xs"></i>
                                                {% else %}
                                                    <i class="fas fa-shipping-fast text-xs"></i>
                                                {% endif %}
                                            </div>
                                            <div class="w-0.5 h-full {% if order.status == 'DELIVERED' %}bg-green-500{% else %}bg-gray-200{% endif %}"></div>
                                        </div>
                                        <div class="pb-8">
                                            <h3 class="font-bold {% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}text-gray-900{% else %}text-gray-400{% endif %}">Expédiée</h3>
                                            <p class="{% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}text-gray-600{% else %}text-gray-400{% endif %} text-sm">Le livreur est en route.</p>
                                        </div>
                                    </div>

                                    <div class="flex gap-4">
                                        <div class="flex flex-col items-center">
                                            <div class="w-8 h-8 rounded-full {% if order.status == 'DELIVERED' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-400{% endif %} flex items-center justify-center shrink-0 z-10">
                                                <i class="fas fa-gift text-xs"></i>
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="font-bold {% if order.status == 'DELIVERED' %}text-gray-900{% else %}text-gray-400{% endif %}">Livrée</h3>
                                            <p class="{% if order.status == 'DELIVERED' %}text-gray-600{% else %}text-gray-400{% endif %} text-sm">
                                                {% if order.status == 'DELIVERED' %}
                                                    Colis reçu ! Merci de votre confiance.
                                                {% else %}
                                                    Bientôt chez vous.
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8">
                                <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                                    <i class="fas fa-map-marker-alt text-blue-500 mr-3"></i>
                                    Informations de livraison
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-medium text-gray-900 mb-3">Adresse de livraison</h3>
                                        <address class="text-gray-600 not-italic">
                                            <p class="font-bold text-gray-900">{{ order.full_name }}</p>
                                            <p>{{ order.address }}</p>
                                            <p>{{ order.city }}</p>
                                            <p class="mt-2"><i class="fas fa-phone mr-2 text-sm"></i>{{ order.phone }}</p>
                                            <p><i class="fas fa-envelope mr-2 text-sm"></i>{{ order.email }}</p>
                                        </address>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-xl">
                                        <h3 class="font-medium text-blue-900 mb-2">Méthode d'expédition</h3>
                                        <p class="text-blue-800 font-bold">Standard (Livraison à domicile)</p>
                                        <p class="text-sm text-blue-700 mt-2">
                                            Statut actuel : <span class="font-bold">{{ order.get_status_display }}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="fade-in-delay-2">
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 md:p-8 sticky top-24">
                                <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                                    <i class="fas fa-receipt text-blue-500 mr-3"></i>
                                    Récapitulatif ({{ order.items.count }} articles)
                                </h2>
                                
                                <div class="max-h-96 overflow-y-auto pr-2 mb-6 custom-scrollbar">
                                    {% for item in order.items.all %}
                                    <div class="flex items-start py-4 border-b border-gray-100 last:border-0">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.nom }}" class="w-16 h-16 rounded-lg object-cover mr-4 bg-gray-50">
                                        {% else %}
                                            <div class="w-16 h-16 rounded-lg bg-gray-100 mr-4 flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400"></i>
                                            </div>
                                        {% endif %}
                                        
                                        <div class="flex-grow">
                                            <h4 class="font-medium text-gray-900">{{ item.product.nom }}</h4>
                                            <p class="text-gray-500 text-sm">Qté : {{ item.quantity }}</p>
                                            <p class="font-medium text-gray-900">{{ item.total_price }} FCFA</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <div class="border-t border-gray-200 pt-6 space-y-3">
                                    <div class="flex justify-between text-gray-600">
                                        <span>Total articles</span>
                                        <span>{{ order.total_amount }} FCFA</span>
                                    </div>
                                    <div class="flex justify-between text-gray-600">
                                        <span>Frais de livraison</span>
                                        <span class="text-green-600 font-medium">{% if order.shipping_cost == 0 %}Gratuit{% else %}{{ order.shipping_cost }} FCFA{% endif %}</span>
                                    </div>
                                    <div class="flex justify-between items-center py-4 border-t border-gray-200">
                                        <span class="text-lg font-bold">Total payé</span>
                                        <span class="text-2xl font-bold text-blue-600">{{ order.total_amount }} FCFA</span>
                                    </div>
                                </div>

                                <a href="{% url 'order_pdf_download' order.id %}" 
                                class="w-full mt-6 py-3 px-4 border-2 border-gray-200 text-gray-700 font-medium rounded-xl hover:bg-gray-50 hover:border-blue-600 hover:text-blue-600 transition-all flex items-center justify-center">
                                    <i class="fas fa-download mr-3"></i>
                                    Télécharger le reçu (PDF)
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12">
                        <a href="{% url 'home' %}" class="bg-blue-600 text-white font-bold py-4 px-10 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all text-center">
                            Continuer mes achats
                        </a>
                        <a href="{% url 'order_history' %}" class="bg-white text-gray-700 border border-gray-300 font-bold py-4 px-10 rounded-xl hover:bg-gray-50 transition-all text-center">
                            Mes commandes
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Configuration de l'explosion de confettis
        const duration = 3 * 1000; // 3 secondes
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();

            if (timeLeft <= 0) {
                return clearInterval(interval);
            }

            const particleCount = 50 * (timeLeft / duration);
            
            // On lance des confettis depuis deux points (gauche et droite)
            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
            });
            confetti({
                ...defaults,
                particleCount,
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
            });
        }, 250);
    });
</script>
{% endblock %}