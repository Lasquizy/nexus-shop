{% extends "admin/index.html" %}
{% load i18n static %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div style="background: {% if nb_stock_alerts > 0 %}linear-gradient(135deg, #ed213a 0%, #93291e 100%){% else %}white{% endif %}; 
            color: {% if nb_stock_alerts > 0 %}white{% else %}#333{% endif %}; 
            padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: {% if nb_stock_alerts == 0 %}1px solid #e0e0e0{% endif %};">
    <div style="font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">Alertes Stock</div>
    <div style="font-size: 2.2em; font-weight: 800; margin-top: 10px;">{{ nb_stock_alerts }}</div>
    <div style="margin-top: 15px; font-size: 0.85em;">
        {% if nb_stock_alerts > 0 %}
            ‚ö†Ô∏è Produits en seuil critique !
        {% else %}
            ‚úÖ Tous les stocks sont bons
        {% endif %}
    </div>
</div>

<div id="content-main">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px;">
        
        <div style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">CA du Mois</div>
            <div style="font-size: 2.2em; font-weight: 800; margin-top: 10px;">{{ ca_mois|floatformat:0 }} <span style="font-size: 0.5em;">FCFA</span></div>
            <div style="margin-top: 15px; font-size: 0.8em; background: rgba(255,255,255,0.2); display: inline-block; padding: 3px 10px; border-radius: 20px;">
                {{ nb_commandes }} commandes pay√©es
            </div>
        </div>

        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div style="font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">B√©n√©fice Net (Est.)</div>
            <div style="font-size: 2.2em; font-weight: 800; margin-top: 10px;">{{ benefice_mois|floatformat:0 }} <span style="font-size: 0.5em;">FCFA</span></div>
            <div style="margin-top: 15px; font-size: 0.8em; color: #f8f9fa;">Marge calcul√©e sur prix d'achat</div>
        </div>

        <div style="background: white; color: #333; padding: 25px; border-radius: 15px; border: 1px solid #e0e0e0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div style="font-size: 0.85em; text-transform: uppercase; color: #888; letter-spacing: 1px;">Status Boutique</div>
            <div style="font-size: 1.8em; font-weight: 700; margin-top: 10px; color: #2a5298;">Ouverte</div>
            <div style="margin-top: 15px; color: #28a745; font-size: 0.9em; font-weight: 600;">
                ‚óè Syst√®me op√©rationnel
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 40px;">
        
        <div style="background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
            <h3 style="margin-top: 0; color: #444; font-size: 1.1em;">üìä √âvolution des ventes (7j)</h3>
            <canvas id="salesChart" height="200"></canvas>
        </div>

        <div style="background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
            <h3 style="margin-top: 0; color: #444; font-size: 1.1em;">üèÜ Top 5 Produits les plus vendus</h3>
            <canvas id="productChart" height="200"></canvas>
        </div>
    </div>
</div>

{% if nb_stock_alerts > 0 %}
<div style="margin-top: 30px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 12px; padding: 20px;">
    <h3 style="color: #c53030; margin-top: 0; display: flex; align-items: center;">
        <span style="margin-right: 10px;">üö©</span> Produits √† r√©approvisionner
    </h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
            <tr style="text-align: left; border-bottom: 2px solid #feb2b2; color: #9b2c2c; font-size: 0.9em;">
                <th style="padding: 10px;">Produit</th>
                <th>Cat√©gorie</th>
                <th>Stock Actuel</th>
                <th>Seuil Alerte</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for product in stock_alert_products %}
            <tr style="border-bottom: 1px solid #fed7d7; font-size: 0.95em;">
                <td style="padding: 12px 10px;"><strong>{{ product.nom }}</strong></td>
                <td>{{ product.categorie.name }}</td>
                <td style="color: #c53030; font-weight: bold;">{{ product.quantite_stocks }}</td>
                <td style="color: #718096;">{{ product.seuil_stocks_bas }}</td>
                <td>
                    <a href="{% url 'admin:shop_product_change' product.id %}" 
                       style="color: #2b6cb0; text-decoration: underline;">Modifier</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
    // Configuration Graphique Lin√©aire (Ventes)
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: {{ sales_labels|safe }},
            datasets: [{
                label: 'Ventes (FCFA)',
                data: {{ sales_values|safe }},
                borderColor: '#2a5298',
                backgroundColor: 'rgba(42, 82, 152, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Configuration Graphique Barres (Top Produits)
    const productCtx = document.getElementById('productChart').getContext('2d');
    new Chart(productCtx, {
        type: 'bar',
        data: {
            labels: {{ top_prod_labels|safe }},
            datasets: [{
                label: 'Quantit√© vendue',
                data: {{ top_prod_values|safe }},
                backgroundColor: '#38ef7d',
                borderRadius: 5
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
</script>

<h2 style="margin-top: 40px; padding-bottom: 10px; border-bottom: 1px solid #eee;">Gestion des Donn√©es</h2>
{{ block.super }}

<style>
    /* Correction pour l'affichage Django Admin */
    .dashboard #content { width: 95%; margin: 0 auto; }
    #content-main { float: none !important; width: 100% !important; }
</style>
{% endblock %}